<div class="row g-4">
  <div class="col-md-4">
    <div class="card border-0 shadow-sm">
      {{#if poster_url}}
      <img src="{{poster_url}}" class="card-img-top" alt="{{title}}">
      {{else}}
      <div class="ratio ratio-2x3 d-flex align-items-center justify-content-center bg-secondary text-white">
        <span class="fw-semibold">No Poster Available</span>
      </div>
      {{/if}}
    </div>
  </div>

  <div class="col-md-8">
    <h1 class="fw-bold mb-2">{{title}}</h1>
    <p class="text-muted mb-3">
      {{year}} • {{runtimeText}} • {{genresText}}
    </p>

    <p class="lead mb-4">{{overview}}</p>

    <div class="mb-3">
      <span class="badge bg-warning text-dark me-2">⭐ {{vote_average}} / 10</span>
      <small class="text-muted">{{vote_count}} votes</small>
    </div>

    <dl class="row small">
      <dt class="col-sm-3">Release date</dt>
      <dd class="col-sm-9">{{release_date}}</dd>

      <dt class="col-sm-3">Countries</dt>
      <dd class="col-sm-9">{{countriesText}}</dd>

      <dt class="col-sm-3">Languages</dt>
      <dd class="col-sm-9">{{languagesText}}</dd>

      <dt class="col-sm-3">Production</dt>
      <dd class="col-sm-9">{{companiesText}}</dd>

      <dt class="col-sm-3">Budget</dt>
      <dd class="col-sm-9">${{budget}}</dd>

      <dt class="col-sm-3">Revenue</dt>
      <dd class="col-sm-9">${{revenue}}</dd>
    </dl>

    <div class="mt-3">
      <a href="/movies" class="btn btn-outline-primary rounded-pill px-4">
        ← Back to Listings
      </a>

      {{#if homepage}}
      <a href="{{homepage}}" target="_blank" class="btn btn-primary rounded-pill px-4 ms-2">
        Official Site
      </a>
      {{/if}}

      <!-- Edit & Delete: only visible when logged in (via JS) -->
      <a href="/movie/{{id}}/edit"
         id="editBtn"
         class="btn btn-outline-secondary rounded-pill px-4 ms-2">
        Edit
      </a>

      <button id="deleteBtn"
              class="btn btn-outline-danger rounded-pill px-4 ms-2">
        Delete
      </button>

      <p class="text-danger mt-3" id="detailError" style="display:none;"></p>
    </div>
  </div>
</div>

<script>
(function () {
  const token = localStorage.getItem('jwt');
  const editBtn = document.getElementById('editBtn');
  const deleteBtn = document.getElementById('deleteBtn');
  const errorEl = document.getElementById('detailError');

  // Hide edit/delete completely if NOT logged in
  if (!token) {
    if (editBtn) editBtn.style.display = 'none';
    if (deleteBtn) deleteBtn.style.display = 'none';
    return;
  }

  // Logged in: allow delete via protected API
  if (deleteBtn) {
    deleteBtn.addEventListener('click', async () => {
      if (!confirm('Delete this movie?')) return;

      errorEl.style.display = 'none';
      errorEl.textContent = '';

      try {
        const res = await fetch('/api/movies/{{id}}', {
          method: 'DELETE',
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          errorEl.textContent = data.error || 'Delete failed.';
          errorEl.style.display = 'block';
          return;
        }

        window.location.href = '/movies';
      } catch (err) {
        errorEl.textContent = 'Network error while deleting movie.';
        errorEl.style.display = 'block';
      }
    });
  }
})();
</script>
