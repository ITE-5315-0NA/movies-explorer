<div class="row g-4">
  <div class="col-md-4">
    <div class="card border-0 shadow-sm movie-poster-card">
      {{#if poster_url}}
        <img src="{{poster_url}}" class="card-img-top" alt="{{title}}">
      {{else}}
        <div class="ratio ratio-2x3 d-flex align-items-center justify-content-center bg-secondary text-white">
          <span class="fw-semibold">No Poster Available</span>
        </div>
      {{/if}}
    </div>
  </div>

  <div class="col-md-8">
    <h1 class="fw-bold mb-2">{{title}}</h1>
    <p class="text-muted mb-3">
      {{year}} • {{runtimeText}} • {{genresText}}
    </p>

    <p class="lead mb-4">{{overview}}</p>

    <div class="mb-3">
      <span class="badge bg-warning text-dark me-2">⭐ {{vote_average}} / 10</span>
      <small class="text-muted">{{vote_count}} votes</small>
    </div>

    <dl class="row small">
      <dt class="col-sm-3">Release date</dt>
      <dd class="col-sm-9">{{release_date}}</dd>

      <dt class="col-sm-3">Countries</dt>
      <dd class="col-sm-9">{{countriesText}}</dd>

      <dt class="col-sm-3">Languages</dt>
      <dd class="col-sm-9">{{languagesText}}</dd>

      <dt class="col-sm-3">Production</dt>
      <dd class="col-sm-9">{{companiesText}}</dd>

      <dt class="col-sm-3">Budget</dt>
      <dd class="col-sm-9">${{budget}}</dd>

      <dt class="col-sm-3">Revenue</dt>
      <dd class="col-sm-9">${{revenue}}</dd>
    </dl>

    <div class="mt-3">
      <a href="/movies" class="btn btn-outline-primary rounded-pill px-4">
        ← Back to Listings
      </a>

      {{#if homepage}}
        <a href="{{homepage}}" target="_blank" class="btn btn-primary rounded-pill px-4 ms-2">
          Official Site
        </a>
      {{/if}}

      <!-- USER FEATURES -->
      <button id="watchlistBtn"
              class="btn btn-success rounded-pill px-4 ms-2">
        Add to Watchlist
      </button>

      <p class="text-danger mt-3" id="detailError" style="display:none;"></p>
      <p class="text-success mt-3" id="detailSuccess" style="display:none;"></p>
    </div>
  </div>
</div>

<hr class="my-4">

<!-- My review form + reviews list -->
<div class="mt-3">
  <h3 class="h5 mb-3">Reviews</h3>

  <!-- My review form -->
  <div id="myReviewBox" class="card bg-dark border-0 shadow-sm mb-4">
    <div class="card-body">
      <h6 class="card-title mb-3">Add / Edit your review</h6>
      <form id="reviewForm" class="row g-3">
        <div class="col-sm-3">
          <label class="form-label">Rating (1–10)</label>
          <input type="number"
                 min="1"
                 max="10"
                 step="1"
                 class="form-control"
                 id="reviewRating">
        </div>
        <div class="col-sm-9">
          <label class="form-label">Comment</label>
          <textarea rows="2" class="form-control" id="reviewComment"></textarea>
        </div>
        <div class="col-12 d-flex gap-2">
          <button type="submit" class="btn btn-primary rounded-pill px-4">
            Save review
          </button>
          <button type="button"
                  id="clearReviewBtn"
                  class="btn btn-outline-danger rounded-pill px-4">
            Delete my review
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- All reviews list -->
  <div id="reviewsContainer">
    <!-- Filled by JS -->
  </div>
</div>

<script>
(function () {
  const movieId = {{id}};
  const movieTitle = "{{title}}";
  const posterUrl = "{{poster_url}}";

  const watchlistBtn = document.getElementById('watchlistBtn');
  const errorEl = document.getElementById('detailError');
  const successEl = document.getElementById('detailSuccess');
  const reviewsContainer = document.getElementById('reviewsContainer');

  const reviewForm = document.getElementById('reviewForm');
  const ratingInput = document.getElementById('reviewRating');
  const commentInput = document.getElementById('reviewComment');
  const clearReviewBtn = document.getElementById('clearReviewBtn');

  let myReviewId = null;

  function getToken() {
    return localStorage.getItem('jwt');
  }

  function getCurrentUserId() {
    const token = getToken();
    if (!token) return null;
    try {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(
        atob(base64).split('').map(c =>
          '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
        ).join('')
      );
      const payload = JSON.parse(jsonPayload);
      return payload.id || payload._id || null;
    } catch (e) {
      return null;
    }
  }

  function requireLogin() {
    window.location.href = `/auth/login?redirect=/movie/${movieId}`;
  }

  function showError(msg) {
    errorEl.textContent = msg;
    errorEl.style.display = 'block';
    successEl.style.display = 'none';
  }

  function showSuccess(msg) {
    successEl.textContent = msg;
    successEl.style.display = 'block';
    errorEl.style.display = 'none';
  }

  // Load reviews list and detect if user already has one
  async function loadReviews() {
    try {
      const res = await fetch(`/api/movies/${movieId}/reviews`);
      const reviews = await res.json();
      if (!Array.isArray(reviews) || reviews.length === 0) {
        reviewsContainer.innerHTML = '<p class="text-muted">No reviews yet.</p>';
      } else {
        reviewsContainer.innerHTML = reviews.map(r => `
          <div class="mb-3 border-bottom pb-2">
            <strong>${r.user?.email || 'User'}</strong>
            <span class="badge bg-warning text-dark ms-2">${r.rating}/10</span>
            <div class="small text-muted">${new Date(r.createdAt).toLocaleString()}</div>
            <p class="mb-0">${r.comment || ''}</p>
          </div>
        `).join('');
      }

      const currentUserId = getCurrentUserId();
      if (!currentUserId || !Array.isArray(reviews)) return;

      const myReview = reviews.find(r => r.user && (
        r.user._id === currentUserId || r.user === currentUserId
      ));

      if (myReview) {
        myReviewId = myReview._id;
        localStorage.setItem(`hasReview-${movieId}`, '1');
      }
    } catch (e) {
      reviewsContainer.innerHTML = '<p class="text-danger">Failed to load reviews.</p>';
    }
  }

  loadReviews();

  // Add to watchlist
  if (watchlistBtn) {
    watchlistBtn.addEventListener('click', async () => {
      const token = getToken();
      if (!token) return requireLogin();

      try {
        const res = await fetch('/api/watchlist', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({
            movieId,
            movieTitle,
            poster_url: posterUrl
          })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          showError(data.error || 'Could not add to watchlist.');
          return;
        }
        showSuccess('Added to your watchlist.');
      } catch (err) {
        showError('Network error while adding to watchlist.');
      }
    });
  }

  // When user focuses review form again after first review, show info
  if (reviewForm) {
    reviewForm.addEventListener('focusin', () => {
      if (myReviewId && localStorage.getItem(`hasReview-${movieId}`) === '1') {
        showError('You have already reviewed this movie. Updating the form and saving will replace your previous review.');
      }
    });
  }

  // Save review via form (create or edit)
  if (reviewForm) {
    reviewForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const token = getToken();
      if (!token) return requireLogin();

      const rating = Number(ratingInput.value);
      const comment = commentInput.value.trim();

      if (Number.isNaN(rating) || rating < 1 || rating > 10) {
        showError('Rating must be a number between 1 and 10.');
        return;
      }

      const payload = { rating, comment };

      try {
        let url, method;
        if (myReviewId) {
          url = `/api/reviews/${myReviewId}`;
          method = 'PUT';
        } else {
          url = `/api/movies/${movieId}/reviews`;
          method = 'POST';
        }

        const res = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify(payload)
        });
        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          showError(data.error || 'Could not save review.');
          return;
        }

        myReviewId = data._id || myReviewId;
        localStorage.setItem(`hasReview-${movieId}`, '1');
        ratingInput.value = '';
        commentInput.value = '';
        showSuccess('Your review has been saved.');
        loadReviews();
      } catch (err) {
        showError('Network error while saving review.');
      }
    });
  }

  // Delete my review via button
  if (clearReviewBtn) {
    clearReviewBtn.addEventListener('click', async () => {
      const token = getToken();
      if (!token) return requireLogin();

      if (!myReviewId) {
        showError('You have no review to delete yet.');
        return;
      }
      if (!confirm('Delete your review?')) return;

      try {
        const res = await fetch(`/api/reviews/${myReviewId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          showError(data.error || 'Could not delete review.');
          return;
        }
        myReviewId = null;
        ratingInput.value = '';
        commentInput.value = '';
        localStorage.removeItem(`hasReview-${movieId}`);
        showSuccess('Your review has been deleted.');
        loadReviews();
      } catch (err) {
        showError('Network error while deleting review.');
      }
    });
  }
})();
</script>
